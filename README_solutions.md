# Commit 17a57fd86 QPSé™ä½é—®é¢˜ - è§£å†³æ–¹æ¡ˆæ€»ç»“

## é—®é¢˜æ ¹æº

Commit 17a57fd86 å¼•å…¥çš„ä¼˜åŒ–åœ¨é«˜å¹¶å‘ä¸‹å¯¼è‡´QPSé™ä½ï¼Œä¸»è¦åŸå› ï¼š

1. **åŒæ­¥é˜»å¡**ï¼š`broadcast_object_list` æ˜¯åŒæ­¥æ“ä½œï¼Œæ‰€æœ‰rankså¿…é¡»ç­‰å¾…
2. **åºåˆ—åŒ–å¼€é”€å·¨å¤§**ï¼šç‰©åŒ–åçš„å¯¹è±¡åŒ…å«å¤§å‹numpyæ•°ç»„/PIL.Imageï¼Œåºåˆ—åŒ–å¼€é”€å¯èƒ½ > 500ms
3. **ä¸²è¡ŒåŒ–ç“¶é¢ˆ**ï¼šEntry rankä¸²è¡Œå¤„ç†ï¼Œéentry rankså¤§é‡æ—¶é—´åœ¨ç­‰å¾…
4. **å•çº¿ç¨‹é˜»å¡**ï¼šScheduleræ˜¯å•çº¿ç¨‹ï¼Œå¹¿æ’­é˜»å¡ä¸»çº¿ç¨‹ï¼Œå½±å“å…¶ä»–æ¶ˆæ¯å¤„ç†

## è§£å†³æ–¹æ¡ˆ

### ğŸ¯ æ–¹æ¡ˆ2ï¼šå»¶è¿Ÿç‰©åŒ–ï¼ˆæ¨èä¼˜å…ˆå®æ–½ï¼‰

**æ ¸å¿ƒæ”¹è¿›**ï¼šåªå¹¿æ’­åŸå§‹dictï¼Œå„rankç‹¬ç«‹æ‰§è¡Œ `from_dict`

**å…³é”®ä»£ç ä¿®æ”¹**ï¼š
```python
# ä¿®æ”¹å‰ï¼šç‰©åŒ–åå¹¿æ’­
if self.is_entry_rank:
    image_inputs = MultimodalInputs.from_dict(raw_mm_inputs)  # ç‰©åŒ–
    obj_list = [image_inputs]  # åºåˆ—åŒ–ç‰©åŒ–å¯¹è±¡ï¼ˆå¤§ï¼‰
    torch.distributed.broadcast_object_list(...)

# ä¿®æ”¹åï¼šåªå¹¿æ’­dict
if group_world_size > 1:
    if self.is_entry_rank:
        obj_list = [raw_mm_inputs]  # åªå¹¿æ’­dictï¼ˆå°ï¼‰
        torch.distributed.broadcast_object_list(...)
    else:
        obj_list = [None]
        torch.distributed.broadcast_object_list(...)  # æ¥æ”¶dict
        raw_mm_inputs = obj_list[0]

# æ‰€æœ‰rankså¹¶è¡Œæ‰§è¡Œfrom_dict
image_inputs = MultimodalInputs.from_dict(raw_mm_inputs)
```

**ä¼˜ç‚¹**ï¼š
- âœ… å®ç°ç®€å•ï¼Œä¿®æ”¹é‡å°ï¼ˆ~20è¡Œä»£ç ï¼‰
- âœ… åºåˆ—åŒ–å¼€é”€ä»æ•°ç™¾æ¯«ç§’é™ä½åˆ°å‡ åæ¯«ç§’
- âœ… é«˜å¹¶å‘ä¸‹QPSæ˜¾è‘—æå‡

**é¢„æœŸæ•ˆæœ**ï¼š
- åºåˆ—åŒ–æ—¶é—´ï¼š500ms â†’ 50msï¼ˆ10å€æå‡ï¼‰
- é«˜å¹¶å‘QPSï¼šæå‡2-3å€

---

### ğŸš€ æ–¹æ¡ˆ1ï¼šå¼‚æ­¥é€šä¿¡ï¼ˆè¿›ä¸€æ­¥ä¼˜åŒ–ï¼‰

**æ ¸å¿ƒæ”¹è¿›**ï¼šä½¿ç”¨åå°çº¿ç¨‹å¤„ç†å¹¿æ’­ï¼Œä¸»çº¿ç¨‹å¯ä»¥ç»§ç»­å¤„ç†å…¶ä»–è¯·æ±‚

**å…³é”®å®ç°**ï¼š
- ä½¿ç”¨ `ThreadPoolExecutor` åˆ›å»ºåå°çº¿ç¨‹æ± 
- ä½¿ç”¨ `Future` å¯¹è±¡å®ç°å¼‚æ­¥ç­‰å¾…
- Entry rankå’Œnon-entry rankséƒ½åœ¨åå°çº¿ç¨‹ä¸­å¤„ç†

**ä¼˜ç‚¹**ï¼š
- âœ… å®Œå…¨è§£å†³é˜»å¡é—®é¢˜
- âœ… ä¸»çº¿ç¨‹å¯ä»¥å¹¶è¡Œå¤„ç†å¤šä¸ªè¯·æ±‚
- âœ… é«˜å¹¶å‘ä¸‹QPSè¿›ä¸€æ­¥æå‡

**ç¼ºç‚¹**ï¼š
- âš ï¸ å®ç°å¤æ‚åº¦è¾ƒé«˜ï¼ˆéœ€è¦çº¿ç¨‹ç®¡ç†ï¼‰
- âš ï¸ éœ€è¦å¤„ç†çº¿ç¨‹å®‰å…¨å’Œå¼‚å¸¸ä¼ æ’­

**é¢„æœŸæ•ˆæœ**ï¼š
- é«˜å¹¶å‘QPSï¼šåœ¨æ–¹æ¡ˆ2åŸºç¡€ä¸Šå†æå‡1.5-2å€
- å®Œå…¨æ¶ˆé™¤é˜»å¡å½±å“

---

### ğŸ† æ–¹æ¡ˆ3ï¼šç»„åˆæ–¹æ¡ˆï¼ˆæœ€ä½³æ€§èƒ½ï¼‰

ç»“åˆæ–¹æ¡ˆ1å’Œæ–¹æ¡ˆ2ï¼š
- ä½¿ç”¨å»¶è¿Ÿç‰©åŒ–ï¼šåªå¹¿æ’­dict
- ä½¿ç”¨å¼‚æ­¥é€šä¿¡ï¼šåå°çº¿ç¨‹å¤„ç†

**é¢„æœŸæ•ˆæœ**ï¼š
- æœ€ä½³æ€§èƒ½ï¼šæ—¢é¿å…åºåˆ—åŒ–å¼€é”€ï¼Œåˆé¿å…é˜»å¡
- é«˜å¹¶å‘QPSï¼šæå‡3-5å€

---

## å®æ–½å»ºè®®

### é˜¶æ®µ1ï¼šå®æ–½æ–¹æ¡ˆ2ï¼ˆå»¶è¿Ÿç‰©åŒ–ï¼‰

1. **ä¿®æ”¹ä»£ç **ï¼šæŒ‰ç…§ `code_implementation.md` ä¸­çš„æ–¹æ¡ˆ2å®ç°ä¿®æ”¹
2. **æµ‹è¯•éªŒè¯**ï¼š
   - å•å…ƒæµ‹è¯•ï¼šç¡®ä¿åŠŸèƒ½æ­£ç¡®
   - æ€§èƒ½æµ‹è¯•ï¼šå¯¹æ¯”QPSå’Œå»¶è¿Ÿ
3. **ç°åº¦å‘å¸ƒ**ï¼šå…ˆåœ¨å°è§„æ¨¡ç¯å¢ƒéªŒè¯
4. **ç›‘æ§è§‚å¯Ÿ**ï¼šè§‚å¯ŸQPSã€CPUã€å»¶è¿Ÿç­‰æŒ‡æ ‡

**é¢„è®¡æ—¶é—´**ï¼š1-2å¤©

### é˜¶æ®µ2ï¼ˆå¦‚éœ€è¦ï¼‰ï¼šå®æ–½æ–¹æ¡ˆ1æˆ–3

å¦‚æœæ–¹æ¡ˆ2åä»æœ‰é˜»å¡é—®é¢˜ï¼Œå†å®æ–½æ–¹æ¡ˆ1æˆ–ç»„åˆæ–¹æ¡ˆ3ã€‚

**é¢„è®¡æ—¶é—´**ï¼š3-5å¤©

---

## æ–‡æ¡£ç´¢å¼•

- **`analysis_qps_drop.md`** - è¯¦ç»†çš„é—®é¢˜åˆ†æ
- **`solution_design.md`** - å®Œæ•´çš„è®¾è®¡æ–¹æ¡ˆå’Œæ¶æ„è¯´æ˜
- **`code_implementation.md`** - å…·ä½“çš„ä»£ç å®ç°ç¤ºä¾‹

---

## å…³é”®æŒ‡æ ‡ç›‘æ§

å®æ–½åéœ€è¦ç›‘æ§ï¼š
- âœ… **QPS**ï¼šæ•´ä½“ååé‡å˜åŒ–
- âœ… **CPUå ç”¨ç‡**ï¼šæ˜¯å¦é™ä½
- âœ… **è¯·æ±‚å»¶è¿Ÿ**ï¼šp50/p99å»¶è¿Ÿ
- âœ… **å¹¿æ’­æ—¶é—´**ï¼šdictå¹¿æ’­ vs ç‰©åŒ–å¯¹è±¡å¹¿æ’­
- âœ… **from_dictæ—¶é—´**ï¼šå„rankçš„æ‰§è¡Œæ—¶é—´

---

## å¿«é€Ÿå¼€å§‹

### æœ€å°ä¿®æ”¹ï¼ˆæ–¹æ¡ˆ2ï¼‰

ä¿®æ”¹ `python/sglang/srt/managers/scheduler.py` ä¸­çš„ `_process_and_broadcast_mm_inputs` æ–¹æ³•ï¼š

```python
def _process_and_broadcast_mm_inputs(self, raw_mm_inputs: Optional[dict]):
    if raw_mm_inputs is None:
        return None
    
    # ... è·å–group_world_size ...
    
    # åªå¹¿æ’­åŸå§‹dict
    if group_world_size > 1:
        if self.is_entry_rank:
            obj_list = [raw_mm_inputs]
            torch.distributed.broadcast_object_list(
                obj_list, src=0, group=self.cpu_group
            )
            raw_mm_inputs = obj_list[0]
        else:
            obj_list = [None]
            torch.distributed.broadcast_object_list(
                obj_list, src=0, group=self.cpu_group
            )
            raw_mm_inputs = obj_list[0]
    
    # æ‰€æœ‰rankså¹¶è¡Œæ‰§è¡Œfrom_dict
    return MultimodalInputs.from_dict(raw_mm_inputs)
```

è¯¦ç»†å®ç°è¯·å‚è€ƒ `code_implementation.md`ã€‚
