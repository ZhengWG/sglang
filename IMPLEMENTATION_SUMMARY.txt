=====================================================
å¤šæ¨¡æ€Embedding Resumeä¼ è¾“ - å®ç°å®Œæˆ
=====================================================

ç‰ˆæœ¬: v6.0-final
å®Œæˆæ—¶é—´: 2025-10-20
çŠ¶æ€: âœ… Ready for Testing

=====================================================
æ ¸å¿ƒæ”¹è¿›
=====================================================

âœ… æ”¯æŒéè¿ç»­blockåˆ†é…
   - è§£å†³ï¼šfreeæ—¶é—´ä¸ç¡®å®šå¯¼è‡´blocksä¹±åº
   - æ–¹æ¡ˆï¼šblock_indiceså¯ä»¥ä¸è¿ç»­ï¼Œä½†æ•°æ®å­˜å‚¨åœ¨è¿ç»­åŒºåŸŸ
   - å…¬å¼ï¼šstart_offset = min(block_indices) * block_size

âœ… Resumeä¼ è¾“æœºåˆ¶
   - Languageä¾§é¦–æ¬¡åˆ†é…ï¼šalloc_default() -> 8 blocks (1024 tokens)
   - æ£€æµ‹é•¿åº¦ä¸è¶³ï¼štotal_length > default_buffer_tokens
   - è‡ªåŠ¨Resumeï¼šé‡æ–°åˆ†é… + resume_transfer(sent_tokens)

âœ… ä¸“ä¸šå‘½å
   - resume_transfer (æ›¿ä»£ continuation)
   - buffered_chunks (æ›¿ä»£ partial_data)
   - transferred_tokens (æ›¿ä»£ received_tokens)

=====================================================
æ•°æ®ç»“æ„
=====================================================

@dataclass
class MetadataAllocation:
    block_indices: List[int]  # å¯èƒ½ä¸è¿ç»­ï¼Œå¦‚[15,16,14,13,10]
    num_tokens: int            # å®é™…tokenæ•°
    start_offset: int          # æ•°æ®å­˜å‚¨èµ·å§‹ä½ç½®ï¼ˆè¿ç»­ï¼‰

ç¤ºä¾‹ï¼š
  block_indices=[15,16,17,18,19,14,13,12,11,10]  # âŒ ä¹±åº
  start_offset=1280  # âœ… min([15,...,10]) * 128
  æ•°æ®èŒƒå›´=[1280, 2560)  # âœ… è¿ç»­

=====================================================
é…ç½®å‚æ•°
=====================================================

export SGLANG_MULTIMODAL_BLOCK_SIZE=128           # Blockå¤§å°
export SGLANG_DEFAULT_MULTIMODAL_BLOCKS=8         # é»˜è®¤8ä¸ªblocks
export SGLANG_EMBEDDING_CACHE_BUFFER_SIZE=64      # Bufferæ€»æ•°

è®¡ç®—ï¼š
  default_buffer_tokens = 8 * 128 = 1024 tokens

=====================================================
ä»£ç å˜æ›´
=====================================================

æ–‡ä»¶ï¼š
  - utils.py (Blockåˆ†é…å™¨ + Bufferç®¡ç†)
  - conn_multimodal.py (Resumeåè®®)
  - multimodal_embedding.py (åˆ†æ‰¹å‘é€)
  - multimodal_language.py (Resumeæ¥æ”¶)

ç»Ÿè®¡ï¼š
  4 files changed, 40 insertions(+), 29 deletions(-)

è´¨é‡ï¼š
  âœ… Linter: 0 errors
  âœ… éªŒè¯: Pythonæµ‹è¯•é€šè¿‡
  âœ… è®¾è®¡: æ”¯æŒéè¿ç»­åˆ†é…

=====================================================
éªŒè¯ç»“æœ
=====================================================

æµ‹è¯•1ï¼šéè¿ç»­blocks
  è¾“å…¥: free_blocks=[15,16,17,18,19,14,13,12,11,10,...]
  åˆ†é…: 10 blocks
  ç»“æœ: block_indices=[15,16,17,18,19,14,13,12,11,10]
        start_offset=1280 (=min*128)
  âœ… Blocksä¸è¿ç»­ä½†æ•°æ®è¿ç»­å­˜å‚¨

æµ‹è¯•2ï¼šæ•°æ®ä¸é‡å 
  A: blocks=[5,6,7,8,9], data=[640,1280)
  B: blocks=[15,16,...,10], data=[1280,2560)
  âœ… æ— é‡å 

æµ‹è¯•3ï¼šResumeæµç¨‹
  å®é™…2000 tokensï¼Œé»˜è®¤1024
  ç¬¬1æ¬¡: å‘é€1024 + aux[total=2000]
  Resume: å‘é€å‰©ä½™976
  âœ… æ‹¼æ¥æˆåŠŸï¼š1024+976=2000

=====================================================
å¿«é€Ÿæµ‹è¯•
=====================================================

# Embeddingä¾§
python -m sglang.launch_server \
    --model-path /path/to/model \
    --disaggregation-mode encode \
    --disaggregation-bootstrap-port 8001

# Languageä¾§
python -m sglang.launch_server \
    --model-path /path/to/model \
    --disaggregation-mode language \
    --disaggregation-bootstrap-addr localhost:8001

# ç›‘æ§
tail -f logs/*.log | grep -E "resume|block_indices|start_offset"

=====================================================
æ–‡æ¡£
=====================================================

ä¸»æ–‡æ¡£: MULTIMODAL_RESUME_TRANSFER.md

=====================================================
ä¸‹ä¸€æ­¥
=====================================================

1. é›†æˆæµ‹è¯•
2. æ€§èƒ½æµ‹è¯•
3. ç”Ÿäº§ç¯å¢ƒè¯•ç‚¹

=====================================================
ğŸ‰ å®ç°å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•ï¼
=====================================================
